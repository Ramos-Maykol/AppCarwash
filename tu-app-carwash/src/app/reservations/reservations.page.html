<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Mis Reservas</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="nuevaReserva()">
        <ion-icon slot="icon-only" name="add-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="cargarReservas($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="reservations-container">
    <!-- Filters -->
    <ion-segment [value]="selectedFilter()" (ionChange)="onFilterChange($event)" class="filter-segment">
      <ion-segment-button value="todas">
        <ion-label>Todas</ion-label>
      </ion-segment-button>
      <ion-segment-button value="activas">
        <ion-label>Activas</ion-label>
      </ion-segment-button>
      <ion-segment-button value="completadas">
        <ion-label>Completadas</ion-label>
      </ion-segment-button>
      <ion-segment-button value="canceladas">
        <ion-label>Canceladas</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-container">
      <ion-spinner></ion-spinner>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading() && (reservasFiltradas() || []).length === 0" class="empty-state">
      <ion-icon name="calendar-outline" class="empty-icon"></ion-icon>
      <h2>No hay reservas</h2>
      <p *ngIf="selectedFilter() === 'todas'">AÃºn no has realizado ninguna reserva</p>
      <p *ngIf="selectedFilter() === 'activas'">No tienes reservas activas</p>
      <p *ngIf="selectedFilter() === 'completadas'">No tienes reservas completadas</p>
      <p *ngIf="selectedFilter() === 'canceladas'">No tienes reservas canceladas</p>
      <ion-button (click)="nuevaReserva()" class="empty-button">
        <ion-icon slot="start" name="add-outline"></ion-icon>
        Nueva Reserva
      </ion-button>
    </div>

    <!-- Reservations List -->
    <div *ngIf="!isLoading() && (reservasFiltradas() || []).length > 0" class="reservations-list">
      <ion-card *ngFor="let reserva of reservasFiltradas() || []" class="reservation-card">
        <ion-card-content>
          <div class="reservation-header">
            <div class="reservation-info">
              <h3>{{ reserva.servicio?.nombre }}</h3>
              <ion-badge [class]="getEstadoClass(reserva.estado)">
                {{ getEstadoTexto(reserva.estado) }}
              </ion-badge>
            </div>
            <div class="reservation-price">
              <ion-icon name="cash-outline"></ion-icon>
              <span>${{ reserva.precio_final | number:'1.2-2' }}</span>
            </div>
          </div>

          <div class="reservation-details">
            <div class="detail-row">
              <div class="detail-item">
                <ion-icon name="calendar-outline"></ion-icon>
                <span>{{ formatearFecha(reserva.cupo_horario?.hora_inicio || '') }}</span>
              </div>
              <div class="detail-item">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ formatearHora(reserva.cupo_horario?.hora_inicio || '') }}</span>
              </div>
            </div>

            <div class="detail-row">
              <div class="detail-item">
                <ion-icon name="location-outline"></ion-icon>
                <span>{{ reserva.cupo_horario?.sucursal?.nombre }}</span>
              </div>
            </div>

            <div class="detail-row">
              <div class="detail-item">
                <ion-icon name="car-outline"></ion-icon>
                <span>{{ reserva.vehiculo?.marca }} {{ reserva.vehiculo?.modelo }}</span>
                <small>{{ reserva.vehiculo?.placa }}</small>
              </div>
            </div>

            <div *ngIf="reserva.observaciones" class="observaciones">
              <strong>Observaciones:</strong>
              <p>{{ reserva.observaciones }}</p>
            </div>
          </div>

          <div *ngIf="puedeSerCancelada(reserva)" class="reservation-actions">
            <ion-button 
              fill="clear" 
              color="danger" 
              size="small"
              (click)="cancelarReserva(reserva.id)">
              <ion-icon slot="start" name="close-circle-outline"></ion-icon>
              Cancelar Reserva
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>
